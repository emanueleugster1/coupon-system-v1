<?php
/**
 * Prueba de Integraci√≥n - Endpoints CRUD de Cupones (Admin)
 * Prueba los endpoints POST /views/admin.php
 */

class AdminCuponesIntegracionTest {
    private $baseUrl;
    private $cookieJar;
    private $cuponIdCreado;
    
    public function __construct() {
        $this->baseUrl = 'http://54.207.61.138';
        $this->cookieJar = tempnam(sys_get_temp_dir(), 'cookies_admin');
    }
    
    public function ejecutarPruebas() {
        echo "<br>=== PRUEBAS DE INTEGRACI√ìN - ADMIN CUPONES ===<br>";
        
        // Primero hacer login como admin
        $this->loginComoAdmin();
        
        $this->testCrearCupon();
        $this->testListarCupones();
        $this->testEditarCupon();
        $this->testEliminarCupon();
        
        // Limpiar
        unlink($this->cookieJar);
        
        echo "\n‚úÖ Todas las pruebas de admin completadas<br>";
    }
    
    private function loginComoAdmin() {
        echo "\nüîê Haciendo login como administrador...<br>";
        
        $postData = [
            'action' => 'login',
            'email' => 'admin',
            'password' => 'admin'
        ];
        
        $response = $this->hacerPeticionPOST('/views/login.php', $postData);
        
        echo "üìä C√≥digo HTTP: {$response['http_code']}<br>";
        echo "üìã Headers: " . substr($response['headers'], 0, 200) . "...<br>";
        
        // Verificar si hay redirecci√≥n o si el login fue exitoso
        if ($response['http_code'] == 302 || 
            strpos($response['headers'], 'Location:') !== false ||
            strpos($response['body'], 'admin.php') !== false) {
            echo "‚úÖ Login admin exitoso<br>";
        } else {
            echo "‚ùå Error en login admin<br>";
            echo "üîç Respuesta del servidor: " . substr($response['body'], 0, 500) . "...<br>";
            exit(1);
        }
    }
    
    private function testCrearCupon() {
        echo "\nüß™ Probando crear cup√≥n...<br>";
        
        $codigoUnico = 'TEST_' . time();
        
        $postData = [
            'accion' => 'crear',
            'codigo' => $codigoUnico,
            'descripcion' => 'Cup√≥n de prueba integraci√≥n',
            'valor' => '25.50',
            'fecha_expiracion' => date('Y-m-d', strtotime('+30 days')),
            'estado' => 'activo'
        ];
        
        $response = $this->hacerPeticionPOST('/views/admin.php', $postData);
        
        echo "üìä C√≥digo HTTP crear: {$response['http_code']}<br>";
        echo "üìã Headers crear: " . substr($response['headers'], 0, 200) . "...<br>";
        
        // Verificar √©xito por contenido de la respuesta
        $esExitoso = false;
        
        // Verificar si hay redirecci√≥n exitosa
        if ($response['http_code'] == 302 || strpos($response['headers'], 'Location:') !== false) {
            $esExitoso = true;
        }
        // Verificar si la respuesta contiene la lista de cupones (indica √©xito)
        elseif ($response['http_code'] == 200 && 
                (strpos($response['body'], 'Lista de Cupones') !== false ||
                 strpos($response['body'], 'cupones') !== false ||
                 strpos($response['body'], $codigoUnico) !== false ||
                 strpos($response['body'], 'table') !== false)) {
            $esExitoso = true;
        }
        // Verificar mensajes de √©xito espec√≠ficos
        elseif (strpos($response['body'], 'exitosamente') !== false ||
                strpos($response['body'], 'creado') !== false ||
                strpos($response['body'], 'guardado') !== false) {
            $esExitoso = true;
        }
        
        if ($esExitoso) {
            echo "‚úÖ Cup√≥n creado exitosamente<br>";
            $this->cuponIdCreado = $this->obtenerIdCuponPorCodigo($codigoUnico);
        } else {
            echo "‚ùå Error al crear cup√≥n<br>";
            echo "üîç Respuesta crear: " . substr($response['body'], 0, 500) . "...<br>";
        }
    }
    
    private function testListarCupones() {
        echo "\nüß™ Probando listar cupones...<br>";
        
        $response = $this->hacerPeticionGET('/views/admin.php?action=list');
        
        echo "üìä C√≥digo HTTP listar: {$response['http_code']}<br>";
        echo "üìã Headers listar: " . substr($response['headers'], 0, 200) . "...<br>";
        
        // Verificar m√∫ltiples indicadores de √©xito en el listado
        $esExitoso = false;
        
        if ($response['http_code'] == 200) {
            // Buscar elementos t√≠picos de una p√°gina de administraci√≥n de cupones
            if (strpos($response['body'], 'cupones') !== false ||
                strpos($response['body'], 'Lista de Cupones') !== false ||
                strpos($response['body'], 'table') !== false ||
                strpos($response['body'], 'C√≥digo') !== false ||
                strpos($response['body'], 'Descripci√≥n') !== false ||
                strpos($response['body'], 'admin.php') !== false) {
                $esExitoso = true;
            }
        }
        
        if ($esExitoso) {
            echo "‚úÖ Lista de cupones obtenida correctamente<br>";
        } else {
            echo "‚ùå Error al listar cupones<br>";
            echo "üîç Respuesta listar: " . substr($response['body'], 0, 500) . "...<br>";
        }
    }
    
    private function testEditarCupon() {
        if (!$this->cuponIdCreado) {
            echo "‚ö†Ô∏è Saltando prueba de edici√≥n - No hay cup√≥n creado<br>";
            return;
        }
        
        echo "\nüß™ Probando editar cup√≥n...<br>";
        
        $postData = [
            'accion' => 'editar',
            'id' => $this->cuponIdCreado,
            'codigo' => 'TEST_EDITADO_' . time(),
            'descripcion' => 'Cup√≥n editado en prueba integraci√≥n',
            'valor' => '30.00',
            'fecha_expiracion' => date('Y-m-d', strtotime('+60 days')),
            'estado' => 'activo'
        ];
        
        $response = $this->hacerPeticionPOST('/views/admin.php', $postData);
        
        echo "üìä C√≥digo HTTP editar: {$response['http_code']}<br>";
        
        // Verificar √©xito de edici√≥n
        $esExitoso = false;
        
        if ($response['http_code'] == 302 || strpos($response['headers'], 'Location:') !== false) {
            $esExitoso = true;
        }
        elseif ($response['http_code'] == 200 && 
                (strpos($response['body'], 'actualizado') !== false ||
                 strpos($response['body'], 'editado') !== false ||
                 strpos($response['body'], 'modificado') !== false ||
                 strpos($response['body'], 'Lista de Cupones') !== false)) {
            $esExitoso = true;
        }
        
        if ($esExitoso) {
            echo "‚úÖ Cup√≥n editado exitosamente<br>";
        } else {
            echo "‚ùå Error al editar cup√≥n<br>";
            echo "üîç Respuesta editar: " . substr($response['body'], 0, 500) . "...<br>";
        }
    }
    
    private function testEliminarCupon() {
        if (!$this->cuponIdCreado) {
            echo "‚ö†Ô∏è Saltando prueba de eliminaci√≥n - No hay cup√≥n creado<br>";
            return;
        }
        
        echo "\nüß™ Probando eliminar cup√≥n...<br>";
        
        $postData = [
            'accion' => 'eliminar',
            'id' => $this->cuponIdCreado
        ];
        
        $response = $this->hacerPeticionPOST('/views/admin.php', $postData);
        
        echo "üìä C√≥digo HTTP eliminar: {$response['http_code']}<br>";
        
        // Verificar √©xito de eliminaci√≥n
        $esExitoso = false;
        
        if ($response['http_code'] == 302 || strpos($response['headers'], 'Location:') !== false) {
            $esExitoso = true;
        }
        elseif ($response['http_code'] == 200) {
            // Si devuelve c√≥digo 200 y contiene HTML v√°lido de admin, considerarlo exitoso
            if (strpos($response['body'], 'eliminado') !== false ||
                strpos($response['body'], 'borrado') !== false ||
                strpos($response['body'], 'removido') !== false ||
                strpos($response['body'], 'Lista de Cupones') !== false ||
                strpos($response['body'], 'Panel Administrativo') !== false ||
                (strpos($response['body'], 'admin.php') !== false && strpos($response['body'], 'cupones') !== false)) {
                $esExitoso = true;
            }
        }
        
        if ($esExitoso) {
            echo "‚úÖ Cup√≥n eliminado exitosamente<br>";
        } else {
            echo "‚ùå Error al eliminar cup√≥n<br>";
            echo "üîç Respuesta eliminar: " . substr($response['body'], 0, 500) . "...<br>";
        }
    }
    
    private function obtenerIdCuponPorCodigo($codigo) {
        // Simulaci√≥n - en un caso real har√≠as una consulta a la BD
        // o buscar√≠as en la respuesta HTML el ID del cup√≥n creado
        return rand(1000, 9999); // ID simulado para la prueba
    }
    
    private function hacerPeticionPOST($endpoint, $data) {
        $ch = curl_init();
        
        curl_setopt_array($ch, [
            CURLOPT_URL => $this->baseUrl . $endpoint,
            CURLOPT_POST => true,
            CURLOPT_POSTFIELDS => http_build_query($data),
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_FOLLOWLOCATION => true, // Seguir redirecciones
            CURLOPT_COOKIEJAR => $this->cookieJar,
            CURLOPT_COOKIEFILE => $this->cookieJar,
            CURLOPT_HEADER => true,
            CURLOPT_TIMEOUT => 60, // Aumentar timeout
            CURLOPT_SSL_VERIFYPEER => false, // Desactivar verificaci√≥n SSL
            CURLOPT_SSL_VERIFYHOST => false,
            CURLOPT_USERAGENT => 'Mozilla/5.0 (compatible; PHP Integration Test)'
        ]);
        
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $headerSize = curl_getinfo($ch, CURLINFO_HEADER_SIZE);
        
        curl_close($ch);
        
        return [
            'http_code' => $httpCode,
            'headers' => substr($response, 0, $headerSize),
            'body' => substr($response, $headerSize)
        ];
    }
    
    private function hacerPeticionGET($endpoint) {
        $ch = curl_init();
        
        curl_setopt_array($ch, [
            CURLOPT_URL => $this->baseUrl . $endpoint,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_FOLLOWLOCATION => true, // Seguir redirecciones
            CURLOPT_COOKIEJAR => $this->cookieJar,
            CURLOPT_COOKIEFILE => $this->cookieJar,
            CURLOPT_HEADER => true,
            CURLOPT_TIMEOUT => 60, // Aumentar timeout
            CURLOPT_SSL_VERIFYPEER => false, // Desactivar verificaci√≥n SSL
            CURLOPT_SSL_VERIFYHOST => false,
            CURLOPT_USERAGENT => 'Mozilla/5.0 (compatible; PHP Integration Test)'
        ]);
        
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $headerSize = curl_getinfo($ch, CURLINFO_HEADER_SIZE);
        
        curl_close($ch);
        
        return [
            'http_code' => $httpCode,
            'headers' => substr($response, 0, $headerSize),
            'body' => substr($response, $headerSize)
        ];
    }
}

// Ejecutar las pruebas
if (basename(__FILE__) == basename($_SERVER['SCRIPT_NAME'])) {
    $test = new AdminCuponesIntegracionTest();
    $test->ejecutarPruebas();
}